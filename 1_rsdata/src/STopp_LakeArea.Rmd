---
title: "STopp_LakeArea"
author: "Simon Topp"
date: "October 27, 2017"
output: html_document
---

```{python}

import ee
ee.Initialize()

#Global Variables and functions

table = ee.FeatureCollection('users/sntopp/Lakes_ply_20170928') #Uploaded shapefile of waterbodies of interest
lakeNum = int(table.size().getInfo())
lakes = table.toList(lakeNum) 

###Functions

#Simple Landsat cloudscore function 
def cloudScore(image):
    scored = ee.Algorithms.Landsat.simpleCloudScore(image)
    cloudy = scored.select(['cloud']).gte(30)
    cScore = ee.Number(cloudy.reduceRegion(ee.Reducer.sum(),polygon).get("cloud"))
    return image.set({"cScore": cScore})

#Sentinel 2 Cloud Score based on Quality Assessment band
def cloudScoreS2(image):
    qa = image.select('QA60').int16()
    #Clouds and cirrus are bit 10 and 11 respectivly
    cloudBitMask = 2**10
    cirrusBitMask = 2**11
    #Determines cloudy pixels (0 indicating clear pixels).
    cloudMask = qa.bitwiseAnd(cloudBitMask).eq(1).And(qa.bitwiseAnd(cirrusBitMask).eq(1))
    scored = cloudMask.updateMask(cloudMask)
    cScore = ee.Number(scored.reduceRegion(ee.Reducer.sum(),polygon).get('QA60')) #Print to find out name of band
    return image.set({"cScore": cScore})
    

#Water extent and Lake Boundary Functions
def waterExtentL8(image):
    ndwi = image.normalizedDifference(['B3','B5'])
    water = ndwi.lte(0)
    cost = water.eq(0).multiply(1)
    sources = ee.Image().toByte().paint(polygon.centroid(), 1)
    sources = sources.updateMask(sources)
    cumulativeCost = water.cumulativeCost(sources, 8000)
    return image.addBands(water.rename(['water'])).addBands(cumulativeCost.rename(['CC']))


def waterExtentS2(image):
    ndwi = image.normalizedDifference(['B3','B8'])
    water = ndwi.lte(0)
    cost = water.eq(0).multiply(1)
    sources = ee.Image().toByte().paint(polygon.centroid(), 1)
    sources = sources.updateMask(sources)
    cumulativeCost = water.cumulativeCost(sources, 8000)
    return image.addBands(water.rename(['water'])).addBands(cumulativeCost.rename(['CC']))

#Area calculations from Cumulative Cost mapping.    
def waterArea(image):
    area = image.select('CC').eq(0)
    area = area.updateMask(area)
    pArea = area.multiply(ee.Image.pixelArea())
    areaSum = pArea.reduceRegion(ee.Reducer.sum(),polygon.buffer(500), 30) #need to use same resolution as input (30 landsat)
    return image.set({"Area": areaSum.get("CC")})
```

```{python}
#Landsat 8 TOA Tier 1 and real time reflectance For Loop
task = []
state = []
status_task = 0


for i in range(0,lakeNum):
    polygon = ee.Feature(lakes.get(i)).geometry()
    buff = polygon.buffer(200)
    collectionL8 = ee.ImageCollection('LANDSAT/LC08/C01/T1_RT_TOA').filterBounds(buff).sort('DATE_ACQUIRED')
        
    def clipImage(image):
        return image.clip(buff)
    
    #Landsat clip, water mask, and lake area calculations
    L8imageClip = collectionL8.map(clipImage)
    L8imageNoCloud = L8imageClip.map(cloudScore).filter(ee.Filter.lte('cScore', 5))
    L8extent = L8imageNoCloud.map(waterExtentL8)     #Potentially try to save image here.  Python script that downloads URL as png and saves.  Google it.
    L8area = L8extent.map(waterArea)
    
    lakename = str(ee.Feature(lakes.get(i)).get('GNIS_NAME').getInfo())
    L8_Output = ee.FeatureCollection(L8area)
    L8Export = ee.batch.Export.table.toDrive(collection = L8_Output, \
                                               description = 'L8LakeArea_'+lakename, \
                                               folder='UNC\LakeAreas', fileFormat = 'csv')
    task.append(L8Export)
    task[i].start()
    state.append(task[i].status()['state']) 
    while state in ['READY', 'RUNNING']:
        print state + '...'
        state = task.status()['state']
    print 'Done'

```
```{python}
#Sentinel 2 for loop
task = []
state = []
status_task = 0
lakename = str(ee.Feature(lakes.get(i)).get('GNIS_NAME').getInfo())

for i in range(0,lakeNum):
    polygon = ee.Feature(lakes.get(i)).geometry()
    buff = polygon.buffer(200)
    collectionS2= ee.ImageCollection('COPERNICUS/S2').filterBounds(buff).sort('system:time_start')
    
    
    def clipImage(image):
        return image.clip(buff)
       
    #Sentinel 2 clip, water mask, and lake area calculations
    S2imageClip = collectionS2.map(clipImage)
    S2imageNoCloud = S2imageClip.map(cloudScoreS2).filter(ee.Filter.lte('cScore', 5))
    S2extent = S2imageNoCloud.map(waterExtentS2)     #Potentially try to save image here.  Python script that downloads URL as png and saves.  Google it.
    S2area = S2extent.map(waterArea)
     
   
    S2_Output = ee.FeatureCollection(S2area)
    lakename = str(ee.Feature(lakes.get(i)).get('GNIS_NAME').getInfo())
    S2Export = ee.batch.Export.table.toDrive(collection = S2_Output, \
                                               description = 'S2LakeArea_'+ lakename, \
                                               folder='UNC\LakeAreas', fileFormat = 'csv')
   
    task.append(S2Export)
    task[i].start()
   
    state.append(task[i].status()['state']) 
    while state in ['READY', 'RUNNING']:
        print state + '...'
        state = task.status()['state']
    print 'Done'
```

