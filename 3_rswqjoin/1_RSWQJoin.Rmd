---
title: "Landsat Linker"
author: "Matthew Ross"
date: "3/5/2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=F}
library(tidyverse)
library(googledrive)
library(feather)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir='~/Dropbox/UNC-PostDoc All/aquasat/')


```

##Download overpasses from Google Drive
```{r, eval=F}

#Read in the sr matchup folder
folder <- drive_ls('WQP_SR_MatchUps')


#Loop over ids in that folder and download them.
if(length(list.files('3_rswqjoin/data/in/MatchUps') < 500)){
  for(i in 1:nrow(folder)) {
    path=paste0('3_rswqjoin/data/in/MatchUps/',folder$name[i])
    drive_download(as_id(folder$id[i]),
                   path=path)
  }
}

```


## Read in overpass data, stitch and back join to wqp pull 
```{r}
#Read in reflectance matchups
refl <- map_df(list.files('3_rswqjoin/data/in/MatchUps',full.names=T),read_csv) %>%
  na.omit()


#Read in concentration data
conc <- read_feather('2_rsdata/out/WidePull.feather') %>%
  select(-sat)


#Read in inventory
inv <- read_feather('1_wqdata/out/wqp_inventory.feather')
inv.est <- inv %>%
  filter(ResolvedMonitoringLocationTypeName=='Estuary')

#Just rivers and lakes
match <- left_join(refl,conc, by=c('SiteID','Date')) %>%
  filter(!SiteID %in% inv.est$MonitoringLocationIdentifier)


library(randomForest)

names(match)
same <- match %>%
  mutate(index = 1:n()) %>%
  #filter(SampDate-Date == 0) %>%
  filter(clouds < 20) %>%
  filter(pixelCount > 9) %>%
  filter(tss > 0) %>%
  filter(Red > 0) %>%
  filter(Nir > 0) %>%
  filter(Green > 0) %>%
  filter(Blue > 0 & Blue < 10000) %>%
  mutate(tss.bin = cut(tss,breaks=c(0.1,1,10,100,1000,10000),
                      labels=c(0,1,10,100,1000)))%>%
  filter(!is.na(tss.bin)) %>%
  select(tss.bin,Red,Nir,Green,Blue,Swir1,Swir2,sat,clouds,index) 

wavelengths <- tibble(key=c('Red','Nir','Green','Blue','Swir1','Swir2'),
                      wave=c(700,900,550,460,1100,1300))
tss.diff <- same %>%
  gather(key=key,value=value,-clouds,-sat,-tss.bin,-index) %>%
  left_join(wavelengths,by='key') %>%
  arrange(index,wave)


head(tss.diff)
tss.diff %>%
ggplot(.,aes(x=wave,y=value,group=index)) + 
  geom_line() + 
  facet_wrap(~tss.bin) + 
  scale_y_log10()


train <- same %>%
  sample_frac(0.7) 

val <- same %>%
  filter(!index %in% train$index) %>%
  select(-index)

rand <- randomForest(tss.bin ~ ., data=train %>%
                       select(-index), replace=F, ntree=50,importance=T,nperm=2)

val$pred <- predict(rand,val)

good <- val %>%
  filter(pred == tss.bin)


bad <- val %>%
  filter(pred != tss.bin)

head(bad)
nrow(good)/nrow(val)





same.lm <- lm(log10(tss) ~ log10(Green)*log10(Red)*log10(Nir)+clouds,data=same)

summary(same.lm)

ggplot(same,aes(x=(chl),y=Red/Green)) + geom_point() + 
  scale_x_log10() + 
  scale_y_log10() + 
  ylim()


```

