---
title: "3_Flat_Overpasses"
output: html_document
editor_options: 
  chunk_output_type: console
---

###THIS NEEDS MORE COMMENTING###

```{r setup}
library(knitr)
opts_knit$set(root.dir='~/Dropbox/UNC-PostDoc All/aquasat/')
library(feather)
library(googledrive)
library(tidyverse)
library(sf)
library(LAGOSNE)
library(lubridate)

```


#Read in full datasets from WQP and LAGOS

```{r, eval=FALSE}
#Read in wrs inventory with path row
wrs.inv <- read_feather('2_rsdata/out/WRSWaterInventory.feather')

doc <- read_feather('1_wqdata/out/wqp/all_doc.feather') %>%
  filter(Units %in% c('mg/l','ppm')) %>%
  filter(CharacteristicName == 'Organic carbon') %>%
  filter(!is.na(Date)) %>%
  group_by(SiteID,Date) %>%
  summarize(value=mean(Value)) %>%
  inner_join(wrs.inv,by='SiteID') %>%
  mutate(type='doc')



# poc <- read_feather('1_wqdata/out/wqp/all_poc.feather') %>%
#   filter(Units %in% c('mg/l')) %>%
#   filter(!is.na(Date)) %>%
#   group_by(SiteID,Date) %>%
#   summarize(poc=mean(Value))

chl <- read_feather('1_wqdata/out/wqp/all_chlorophyll.feather') %>%
  filter(Units %in% c('ug/l')) %>% 
  filter(CharacteristicName %in% c('Chlorophyll','Chlorophyll a','Chlorophyll a (probe)','Chlorophyll a (probe relative fluorescence','Chlorophyll a, corrected for pheophytin')) %>%
  mutate(Value=Value/1000) %>%
  filter(!is.na(Date)) %>%
  group_by(SiteID,Date) %>%
  summarize(value=mean(Value)) %>%
  inner_join(wrs.inv,by='SiteID') %>%
  mutate(type='chl')


tss <- read_feather('1_wqdata/out/wqp/all_tss.feather') %>%
  filter(Units %in% c('mg/l')) %>%
  filter(!is.na(Date)) %>%
  group_by(SiteID,Date) %>%
  summarize(value=mean(Value)) %>%
  inner_join(wrs.inv,by='SiteID') %>%
  mutate(type='tss')



secchi <- read_feather('1_wqdata/out/wqp/all_secchi.feather') %>%
  filter(Units %in% c('m')) %>%
  filter(!is.na(Date)) %>%
  group_by(SiteID,Date) %>%
  summarize(value=mean(Value)) %>%
  inner_join(wrs.inv,by='SiteID') %>%
  mutate(type='secchi')


#Sites are repeated twice that have two landsat scene overlaps. Will get rid of this downstream when joining 
#Path row to the overpass dataset. 
wqp.flat <- bind_rows(secchi,tss,chl,doc) %>%
  spread(key=type,value=value) %>%
  filter(tss >= 0 & tss < 9999 | is.na(tss)) %>%
  filter(doc >= 0 & doc < 9999 | is.na(doc)) %>%
  filter(chl >= 0 & chl < 9999 | is.na(chl)) %>%
  filter(secchi > 0 & secchi < 1000 | is.na(secchi)) 



```


# Load in lagos data, flatten it and make it look exactly like the wqp.flat
```{r, eval=F}
#lagosne_get('1.087.1')
lagos <- lagosne_load("1.087.1")
lagos.nute <- lagos$epi_nutr %>%
  mutate(SiteID=paste('lagos',lagoslakeid,sep='-')) %>%
  inner_join(wrs.inv,by='SiteID') %>%
  mutate(Date=mdy(as.character(sampledate))) %>%
  dplyr::select(SiteID,Date,max,med,min,PATH,ROW,long,lat,chl=chla,doc,secchi) %>%
  mutate(tss=NA)

wqp.candidates <- bind_rows(wqp.flat,lagos.nute) %>%
  mutate(SampDate=Date) %>% 
  ungroup() %>%
  filter(year(SampDate) > 1970) %>%
  filter(year(SampDate) < 2020)


```


#Read in cloudiness data
```{r, eval=F}

#Load in cloudy dataset which is called dat. 
dat <- read_feather('2_rsdata/out/clouds.feather')

clouds <- dat %>%
  filter(WRS_PATH %in% wrs.inv$PATH &
           WRS_ROW %in% wrs.inv$ROW) %>%
  mutate(sat = str_split_fixed(LANDSAT_ID,'_',5)[,1]) %>%
  mutate(Date=ymd(str_split_fixed(LANDSAT_ID,'_',6)[,4])) %>%
  select(PATH=WRS_PATH,ROW=WRS_ROW,Date,clouds=CLOUD_COVER,sat,time='SENSING_TIME',landsat_id=LANDSAT_ID) 


clouds$sat <- str_split_fixed(clouds$sat,'0',2)[,2]


wqp.pull.same <- inner_join(wqp.candidates,clouds,by=c('PATH','ROW','Date')) %>% 
  ungroup()


#Shoulder the data by 1 day and make sure that sites where sequential samples occur only 
#keep the same day sampling
wqp.pull.plus1 <- wqp.candidates %>%
  mutate(Date = Date + 1) %>%
  anti_join(wqp.pull.same, by=c('SiteID','Date')) %>%
  inner_join(clouds,by=c('PATH','ROW','Date')) %>%
  ungroup()

#Shoulder the data by -1 day
wqp.pull.minus1 <- wqp.candidates %>%
  mutate(Date=Date-1) %>%
  anti_join(wqp.pull.same, by=c('SiteID','Date')) %>%
  inner_join(clouds,by=c('PATH','ROW','Date')) %>%
  ungroup()



wqp.pull <- bind_rows(wqp.pull.same,wqp.pull.plus1,wqp.pull.minus1)

#This should only return date site combos where the site was sampled only the day 
#before and the day after landsat overpass, but not on the same day
wqp.chk <- wqp.pull %>%
  group_by(SiteID,Date,PATH,ROW,sat) %>%
  mutate(n=n()) %>%
  filter(n > 1) %>%
  arrange(SiteID,Date)



write_feather(wqp.pull,path='2_rsdata/out/WidePull.feather')
```

#Read the feather data in and split into path row pushes. If they have more than 5000 data points in a given pathrow, then split that into seperate files <5000
```{r, eval=F}
library(foreach)

wqp.pull <- read_feather('2_rsdata/out/WidePull.feather')


wqp.nest <- wqp.pull %>%
  mutate(pr = paste(PATH,ROW,sep='_')) %>%
  mutate(index = 1:n()) %>%
  mutate(Date=as.character(Date)) %>%
  mutate(SampDate=as.character(SampDate)) 




# #Subsection louisianna for matt.
# wqp.la <- wqp.nest %>%
#   filter(lat > 28.97 & lat < 32.97) %>%
#   filter(long > -92.077 & long < -89.904)
# 
# #write_feather(wqp.la,path='2_rsdata/tmp/wqplouis.feather')


data.splitter <- function(wqp.nest,dir='2_rsdata/out/SplitWide/'){
  pr.index <- unique(wqp.nest$pr)
  #Forloop and while loop to split data into 5000 or less feathers (which is a data requirement of GEE.)
  foreach(i = 1:length(pr.index)) %do%{
    library(tidyverse)
    wqp.sub <- wqp.nest %>%
      filter(pr == pr.index[i])
    if(nrow(wqp.sub) < 5000){
      name = paste0(dir,pr.index[i],'.feather')
      write_feather(wqp.sub,path=name)
    } else {
      exp <- wqp.sub
      ct = 0
      while(nrow(exp) > 0){
        ct = ct+1
        ct.c = paste0('_',ct)
        exp1 <- exp %>%
          slice(1:5000)
        exp <- exp %>%
          filter(!index %in% exp1$index)
        name = paste0(dir,pr.index[i],ct.c,'.feather')
        write_feather(exp1,path=name)
      }
    }
  }
}

data.splitter(wqp.nest,dir='2_rsdata/out/SplitWide/')




```

