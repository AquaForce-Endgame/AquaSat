---
title: "WQP Overlaps"
author: "Matthew Ross"
date: "1/3/2018"
output: html_document
---

# Join WQP inventory data to the landsat wrs tiles. 

In order to avoid sending up extraneous data to the WQP portal, we check for the PATH and ROW of each site that is near landsat-detectable water (from step "1_landsat_site_inventory.Rmd"). Eventually this data will be joined to the actuall concentration data in 3_flat_overpasses.Rmd

```{r setup}
library(knitr)
library(feather)
library(googledrive)
library(tidyverse)
library(sf)
library(LAGOSNE)
library(maps)

#Reset working directory to the top level
opts_knit$set(root.dir='../..')
```

## Load in site data and convert to an sf object
```{r}
#Load in wqp data
winv <- read_feather('2_rsdata/out/unique_site_visible_inv.feather')


#Convert the data into sf object
inv.sf <- st_as_sf(winv,coords=c('long','lat'),crs=4326) %>%
  st_transform(.,2163)

```


```{r}

#Read in usa data
usa = us_states() %>%
  st_transform(.,2163)


#Download and and read in WRS spatial data
download.file('https://landsat.usgs.gov/sites/default/files/documents/wrs2_asc_desc.zip', destfile = paste0(getwd(),'/2_rsdata/in/wrs2_asc_desc.zip'), method = 'curl')

unzip('2_rsdata/in/wrs2_asc_desc.zip', exdir = '2_rsdata/in/')

wrs <- st_read('2_rsdata/in/wrs2_asc_desc/wrs2_asc_desc.shp') %>%
  st_transform(.,2163)

#Convert to sf object
wrs <- st_as_sf(wrs) %>%
  st_transform(.,2163)


#Negative buffer on the wrs tiles in usa by 1 km
wrs.usa <- wrs %>%
  st_buffer(.,0) %>%
  st_intersection(.,usa) %>%
  group_by(PATH,ROW) %>%
  st_buffer(.,-2000) %>%
  na.omit(.) %>%
  ungroup(.) %>%
  filter(PATH < 133 | ROW != 91) # For some reason this covers the entire usa and messes up data downstream

#The above operation clips the wrs tiles to the shape of the usa, which we don't want. So let's keep full tiles
wrs.all.usa <- wrs %>%
  filter(PR %in% wrs.usa$PR) %>%
  select(PR_ID,PATH,ROW)

#Check overpasses
# ggplot() + 
#   geom_sf(data=wrs.all.usa)+
#   geom_sf(data=wrs.usa)
```

#Join inventory to wrs tiles
```{r}
#Use st join to join inventory to wrs path rows
inv.wrs.sf <- st_join(inv.sf,wrs.all.usa) %>%
  st_transform(.,4326)


#Convert this to a tibble
sfc_as_cols <- function(x, names = c("x","y")) {
  stopifnot(inherits(x,"sf") && inherits(sf::st_geometry(x),"sfc_POINT"))
  ret <- do.call(rbind,sf::st_geometry(x))
  ret <- tibble::as_tibble(ret)
  stopifnot(length(names) == ncol(ret))
  ret <- setNames(ret,names)
  dplyr::bind_cols(x,ret)
}

inv.wrs <- sfc_as_cols(inv.wrs.sf,names=c('long','lat')) %>%
  as.tibble() %>%
  dplyr::select(-geometry,-PR_ID) 

#Check the number of sites that didn't overlap
inv.wrs.fail <- inv.wrs.sf%>%
  filter(is.na(PATH))


#Check where these sites are (likely coastal)
# ggplot() + 
#   geom_sf(data=usa) + 
#   geom_sf(data=inv.wrs.fail)

#Turns out it is the florida keys and some island I can't recognize. I'm okay with not having these sites

write_feather(inv.wrs,path='2_rsdata/out/site_inventory_path_row.feather')

#Upload to team drive
drive_upload('2_rsdata/out/site_inventory_path_row.feather', 'watersat/2_rsdata/out/')
```




